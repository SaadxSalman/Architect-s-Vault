<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Server Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white p-8 font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-5xl font-extrabold text-blue-400 mb-2">Network Stats Dashboard</h1>
            <p class="text-gray-400 text-lg">Real-time CPU and RAM metrics from multiple servers via Redis Pub/Sub</p>
        </header>

        <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            </div>
    </div>

    <script>
        const socket = io();
        const dashboard = document.getElementById('dashboard');
        const serverData = {}; // Stores historical data and Chart instances

        // Chart.js global defaults for dark theme
        Chart.defaults.color = '#cbd5e1'; // gray-300
        Chart.defaults.borderColor = '#475569'; // slate-600

        socket.on('stats_update', (data) => {
            if (!serverData[data.id]) {
                createServerCard(data.id);
            }
            updateServerCard(data);
        });

        function createServerCard(id) {
            const card = document.createElement('div');
            card.id = `card-${id}`;
            card.className = "bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg transform hover:scale-105 transition-all duration-200 ease-in-out flex flex-col";
            card.innerHTML = `
                <h3 class="text-2xl font-bold mb-4 text-green-400 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-1.75-3M3 13h18M4 17h16M4 13V6a2 2 0 012-2h12a2 2 0 012 2v7M6 13h12a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2v-4a2 2 0 012-2z"></path></svg>
                    ${id}
                </h3>
                <div class="space-y-4 mb-6 flex-grow">
                    <div>
                        <div class="flex justify-between mb-1 text-lg">
                            <span>CPU Usage</span>
                            <span id="cpu-val-${id}" class="font-bold text-blue-300">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="cpu-bar-${id}" class="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1 text-lg">
                            <span>RAM Usage</span>
                            <span id="ram-val-${id}" class="font-bold text-purple-300">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="ram-bar-${id}" class="bg-purple-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <canvas id="chart-${id}" width="400" height="200"></canvas>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-auto pt-4 border-t border-gray-700">Last updated: <span id="time-${id}" class="font-mono text-gray-400">-</span></p>
            `;
            dashboard.appendChild(card);
            
            // Initialize Chart.js
            const ctx = document.getElementById(`chart-${id}`).getContext('2d');
            serverData[id] = {
                cpuHistory: [],
                ramHistory: [],
                labels: [],
                chart: new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'CPU %',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)', // Tailwind blue-500
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            },
                            {
                                label: 'RAM %',
                                data: [],
                                borderColor: 'rgb(168, 85, 247)', // Tailwind purple-500
                                backgroundColor: 'rgba(168, 85, 247, 0.2)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 10,
                                    padding: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y + '%';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false, // Hide x-axis labels to save space, but data points remain
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: '#334155' // slate-700
                                }
                            }
                        },
                        animation: {
                            duration: 0 // Disable animation for real-time updates
                        }
                    }
                })
            };
        }

        function updateServerCard(data) {
            // Update percentage values and progress bars
            document.getElementById(`cpu-val-${data.id}`).innerText = `${data.cpu}%`;
            document.getElementById(`cpu-bar-${data.id}`).style.width = `${data.cpu}%`;
            document.getElementById(`ram-val-${data.id}`).innerText = `${data.ram}%`;
            document.getElementById(`ram-bar-${data.id}`).style.width = `${data.ram}%`;
            document.getElementById(`time-${data.id}`).innerText = data.timestamp;

            // Update Chart.js data
            const server = serverData[data.id];
            const maxDataPoints = 20; // Keep last 20 data points

            server.labels.push(data.timestamp);
            server.cpuHistory.push(parseFloat(data.cpu));
            server.ramHistory.push(parseFloat(data.ram));

            if (server.labels.length > maxDataPoints) {
                server.labels.shift();
                server.cpuHistory.shift();
                server.ramHistory.shift();
            }

            server.chart.data.labels = server.labels;
            server.chart.data.datasets[0].data = server.cpuHistory;
            server.chart.data.datasets[1].data = server.ramHistory;
            server.chart.update('none'); // 'none' for instant update without animation
        }
    </script>
</body>
</html>